FROM node:10.16.0-alpine AS build-stage
ARG VUE_APP_NAME
ENV VUE_APP_NAME=$VUE_APP_NAME
ARG VUE_APP_INSTANCE
ENV VUE_APP_INSTANCE=$VUE_APP_INSTANCE
ARG VUE_APP_THEME_COLOR
ENV VUE_APP_COLOR=$VUE_APP_THEME_COLOR
ARG VUE_APP_FB_API_KEY
ENV VUE_APP_FB_API_KEY=$VUE_APP_FB_API_KEY
ARG VUE_APP_FB_AUTH_DOMAIN
ENV VUE_APP_FB_AUTH_DOMAIN=$VUE_APP_FB_AUTH_DOMAIN
ARG VUE_APP_FB_DATABASE_URL
ENV VUE_APP_FB_DATABASE_URL=$VUE_APP_FB_DATABASE_URL
ARG VUE_APP_FB_PROJECT_ID
ENV VUE_APP_FB_PROJECT_ID=$VUE_APP_FB_PROJECT_ID
ARG VUE_APP_FB_STORAGE_BUCKET
ENV VUE_APP_FB_STORAGE_BUCKET=$VUE_APP_FB_STORAGE_BUCKET
ARG VUE_APP_FB_MESSAGING_SENDER_ID
ENV VUE_APP_FB_MESSAGING_SENDER_ID=$VUE_APP_FB_MESSAGING_SENDER_ID
ARG VUE_APP_FB_APP_ID
ENV VUE_APP_FB_APP_ID=$VUE_APP_FB_APP_ID
ARG BASE_URL
ENV BASE_URL=$BASE_URL

ARG VUE_APP_S3_BUCKET
ENV VUE_APP_S3_BUCKET=$VUE_APP_S3_BUCKET
ARG VUE_APP_API
ENV VUE_APP_API=$VUE_APP_API
ARG VUE_APP_FATHOM
ENV VUE_APP_FATHOM=$VUE_APP_FATHOM

RUN echo instance && echo $VUE_APP_INSTANCE && apk add --no-cache --virtual .build-deps alpine-sdk python \
 && npm install --production --silent \
 && apk del .build-deps
WORKDIR /app
COPY package*.json ./
COPY . .
RUN npm install
RUN npm install -g @vue/cli
RUN npm run build

FROM nginx:stable-alpine
COPY --from=build-stage /app/docs /usr/share/nginx/html

CMD ["nginx", "-g", "daemon off;"]
